## 大规模智能调度(Scaled Smart Schedule)，简称3S调度技术。

针对数十万终端设备，如何在地区差异的基础上实现统一的智能调度？

如果完全依赖管理员的分配，耗时耗力，而且人的能力参差不齐，也容易发生差错。但是采用统一的调度，地区差异和应用差异也非常大。如何处理这些矛盾？

云栈针对国网物联网平台的实际需求，提出了：标签加daemonset调度结合的技术方案。

- Label标签调度：通过标签解决地区台区差异性问题。每个台区在运营的过程中，往往会逐步形成自己的一些应用组合，和别的台区形成了差别。
- daemonset调度：通过daemonset调度技术，将使得我们的应用部署和运行，由机器来自动检测并自动完成。无需人为干预。管理员需要决策的是：这个台区应该定义哪些标签，剩下的交给机器去完成。

通过主站端的大脑中枢决策，采用调度收敛和最终一致性的技术，台区终端最终会按照管理员的意图自动部署并配置好应用。

## 连接管理

数十万终端，海量的并发连接，多种物联网协议如何共存，业务通道和管理通道如何共享和分离？

针对异常复杂的网络，提出如下解决方案：
- 单一长连接(Keepalive+RPC+RRPC): 为降低管理开销，避免连接资源被应用滥用。在ttu设备和主站端建立一条长连接，该连接已实现了安全认证接入。管理和业务统一共享该连接资源。
- 多通道 MCMS技术(Multiple Channel Merge and Seperate)：无论是管理还是业务，其发起的连接都不是一种，引起需要在长连接内部，建立多条虚拟的通道，每个虚拟通道由主站或ttu设备主动发起创建，使用完释放通道资源。这些虚拟通道的建立，有效解决了管理和业务在一个网络中后，又能在主站端进行精确的识别分离，从而实现链路共享的目的。
- 多协议 MPAD技术(Multiple Protocal Automatic Detachment)：物联网协议众多，NBIot、MQtt、http等各种协议都有各自的应用场景，甚至还有部分国网自有定义的协议，这些协议很多时候并不是排他，而是需要融合。如何在一个链路上支持多种协议的传输？通过协议自动分离(mpad)的技术措施，高效进行解包识别，能够精确从一个连接中快速识别提取出某种协议数据报文。

## 集群高可用

主站需要避免单点故障，提供HA高可用方案。

- HA-LRM技术: 本地资源管理器(LRM)，其主要任务是控制本地节点的服务运行状态， 首先从当前管理器状态文件读取服务的指定工作状态，然后执行相应的操作命令。
- HA-CRM技术：集群资源管理器（CRM），其主要任务是负责集群节点之间的协同决策工作， 具体包括向LRM发送命令，处理命令执行结果，在出现故障时将服务转移到其他节点运行。
- HA-Fence技术：在节点发生故障后，fence能够确保故障节点彻底离线。这样做主要是为了避免在其他节点恢复服务运行时重复运行同一个服务。这是非常重要的，如果不能确保隔离故障节点，就不可能在其他节点安全恢复服务运行。

当某个节点发生故障时，HA技术组件将会自动判断并将业务在其它节点运行。

## 大规模横向扩展

物联网管理平台的横向扩展挑战，不仅仅在于终端设备量大，更在于，物联网主站端管理功能很多。当主站和终端建立好连接后，如何在后续的部分，实现主站和终端之间的互联互通的管理。

- 定向分发Targeted distribution：每个终端在发起连接时，都有一个UUID的唯一标志。主站通过这个标志能准确识别出该终端应该归属于主站集群中的哪个节点。通过定向分发的技术，避免了连接的混乱和浪费，有效克服了
- 查询聚合Query aggregation：面向管理端的北向API在查询时，能够通过查询聚合，获取到全局的信息，而不需要客户端去理解主站集群内部的数据分布。


## 数据库水平扩展

随着设备的增多，数据库查询压力随之增加。数据库本身需要支持sharding技术，应对物联网平台的规模挑战。

1. 数据分片（Shards）

用来保存数据，保证数据的高可用性和一致性。

2. 查询路由（Query Routers）

路由就是数据库代理的实例，客户端直接连接代理，由代理把读写请求路由到指定的Shard上去。

3. 元数据服务器（meta servers）

保存数据库集群的元数据（metadata），包含各个Shard的路由规则。

4. Shard keys

shard key用来确定数据记录在集群分片中的分布。shard key可以是单索引或者是混合索引。
